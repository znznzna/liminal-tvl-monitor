name: Liminal TVL Monitor

on:
  schedule:
    - cron: '*/2 * * * *'  # 2ÂàÜÊØé„Å´ÂÆüË°å
  workflow_dispatch:  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
          
      - name: Get stored TVL value
        id: get_tvl
        run: |
          if [ -f tvl_value.txt ]; then
            LAST_TVL=$(cat tvl_value.txt)
            echo "Found existing TVL value: $LAST_TVL"
          else
            LAST_TVL=0
            echo "No existing TVL file, using default: 0"
          fi
          echo "last_tvl=$LAST_TVL" >> $GITHUB_OUTPUT
          
      - name: Call TVL Monitor API
        id: api_call
        run: |
          LAST_TVL="${{ steps.get_tvl.outputs.last_tvl }}"
          API_URL="https://liminal-tvl-monitor-znznznas-projects.vercel.app/api/monitor-tvl?lastTvl=$LAST_TVL"
          
          echo "Calling API: $API_URL"
          
          # API„ÇíÂëº„Å≥Âá∫„Åó„ÄÅ„É¨„Çπ„Éù„É≥„Çπ„Éò„ÉÉ„ÉÄ„Éº„ÇÇÁ¢∫Ë™ç
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o response.json "$API_URL")
          
          echo "HTTP Status: $HTTP_STATUS"
          echo "Response content (first 500 chars):"
          head -c 500 response.json
          echo ""
          
          # HTML„ÅåËøî„Å£„Å¶„Åç„ÅüÂ†¥ÂêàÔºàË™çË®º„Ç®„É©„ÉºÔºâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          if grep -q "<!doctype html>" response.json; then
            echo "Error: API returned HTML instead of JSON (likely authentication required)"
            echo "Please check Vercel project settings and disable authentication"
            exit 1
          fi
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "API call failed with status: $HTTP_STATUS"
            echo "Full response content:"
            cat response.json
            exit 1
          fi
          
          # JSON„Å®„Åó„Å¶ÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if ! jq empty response.json; then
            echo "Response is not valid JSON"
            echo "Full response:"
            cat response.json
            exit 1
          fi
          
          echo "Valid JSON response received"
          
          # JSON„Åã„ÇâÂÄ§„ÇíÊäΩÂá∫
          CURRENT_TVL=$(jq -r '.currentTvl // 0' response.json)
          INCREASED=$(jq -r '.increased // false' response.json)
          SUCCESS=$(jq -r '.success // false' response.json)
          
          echo "current_tvl=$CURRENT_TVL" >> $GITHUB_OUTPUT
          echo "increased=$INCREASED" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          
          echo "Parsed values:"
          echo "- Current TVL: $CURRENT_TVL"
          echo "- Increased: $INCREASED"
          echo "- Success: $SUCCESS"
          
          # API„ÅåÂ§±Êïó„ÇíËøî„Åó„ÅüÂ†¥Âêà
          if [ "$SUCCESS" != "true" ]; then
            echo "API returned success=false"
            exit 1
          fi
          
      - name: Validate TVL value
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          
          # TVLÂÄ§„ÅåÊï∞ÂÄ§„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if ! [[ "$CURRENT_TVL" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
            echo "Invalid TVL value: $CURRENT_TVL"
            exit 1
          fi
          
          echo "TVL value validated: $CURRENT_TVL"
          
      - name: Save current TVL value
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          echo "$CURRENT_TVL" > tvl_value.txt
          echo "Saved TVL value to file: $CURRENT_TVL"
          
      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
      - name: Commit TVL value if changed
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          
          # „Éï„Ç°„Ç§„É´„Å´Â§âÊõ¥„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if git diff --quiet tvl_value.txt; then
            echo "No changes to TVL value file"
          else
            echo "TVL value file changed, committing..."
            git add tvl_value.txt
            
            if git commit -m "Update TVL value to $CURRENT_TVL"; then
              echo "Successfully committed TVL value"
              
              if git push; then
                echo "Successfully pushed changes"
              else
                echo "Warning: Failed to push changes, but continuing..."
              fi
            else
              echo "Warning: Failed to commit changes, but continuing..."
            fi
          fi
          
      - name: Log monitoring result
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          INCREASED="${{ steps.api_call.outputs.increased }}"
          LAST_TVL="${{ steps.get_tvl.outputs.last_tvl }}"
          
          echo "=== TVL Monitoring Result ==="
          echo "Previous TVL: $LAST_TVL"
          echo "Current TVL: $CURRENT_TVL"
          echo "Increased: $INCREASED"
          
          if [ "$INCREASED" = "true" ]; then
            DIFFERENCE=$(echo "$CURRENT_TVL - $LAST_TVL" | bc -l)
            echo "üöÄ TVL increased by $DIFFERENCE! Discord notification sent."
          else
            echo "üìä TVL check completed. No increase detected."
          fi
          
      - name: Cleanup
        run: |
          rm -f response.json
        if: always()