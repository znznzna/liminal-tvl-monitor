name: Liminal TVL Monitor

on:
  schedule:
    - cron: '*/2 * * * *'  # 2åˆ†æ¯ã«å®Ÿè¡Œ
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  monitor:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿æ¨©é™ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—
          
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq bc
          
      - name: Get stored TVL value
        id: get_tvl
        run: |
          if [ -f tvl_value.txt ]; then
            LAST_TVL=$(cat tvl_value.txt)
            echo "Found existing TVL value: $LAST_TVL"
          else
            LAST_TVL=0
            echo "No existing TVL file, using default: 0"
          fi
          echo "last_tvl=$LAST_TVL" >> $GITHUB_OUTPUT
          
      - name: Call TVL Monitor API
        id: api_call
        run: |
          LAST_TVL="${{ steps.get_tvl.outputs.last_tvl }}"
          API_URL="https://liminal-tvl-monitor-znznznas-projects.vercel.app/api/monitor-tvl?lastTvl=$LAST_TVL"
          
          echo "Calling API: $API_URL"
          
          # APIã‚’å‘¼ã³å‡ºã—
          HTTP_STATUS=$(curl -s -w "%{http_code}" -o response.json "$API_URL")
          
          echo "HTTP Status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "API call failed with status: $HTTP_STATUS"
            cat response.json
            exit 1
          fi
          
          # JSONã‹ã‚‰å€¤ã‚’æŠ½å‡º
          CURRENT_TVL=$(jq -r '.currentTvl // 0' response.json)
          INCREASED=$(jq -r '.increased // false' response.json)
          SUCCESS=$(jq -r '.success // false' response.json)
          
          echo "current_tvl=$CURRENT_TVL" >> $GITHUB_OUTPUT
          echo "increased=$INCREASED" >> $GITHUB_OUTPUT
          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          
          echo "API Results:"
          echo "- Current TVL: $CURRENT_TVL"
          echo "- Increased: $INCREASED"
          echo "- Success: $SUCCESS"
          
      - name: Save TVL value to file
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          echo "Saving TVL value: $CURRENT_TVL"
          echo "$CURRENT_TVL" > tvl_value.txt
          
          # è©³ç´°ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ä½œæˆ
          echo "TVL History Log" > tvl_history.txt
          echo "=================" >> tvl_history.txt
          echo "Last Updated: $TIMESTAMP" >> tvl_history.txt
          echo "Current TVL: $CURRENT_TVL" >> tvl_history.txt
          echo "Previous TVL: ${{ steps.get_tvl.outputs.last_tvl }}" >> tvl_history.txt
          echo "Increased: ${{ steps.api_call.outputs.increased }}" >> tvl_history.txt
          echo "" >> tvl_history.txt
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆç¢ºèª
          if [ -f tvl_value.txt ]; then
            echo "âœ… tvl_value.txt created successfully"
            echo "Content: $(cat tvl_value.txt)"
          else
            echo "âŒ Failed to create tvl_value.txt"
            exit 1
          fi
          
      - name: Commit and push files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          INCREASED="${{ steps.api_call.outputs.increased }}"
          
          # Gitè¨­å®š
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          echo "=== Git Status Before ==="
          git status
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’staging area ã«è¿½åŠ 
          git add tvl_value.txt tvl_history.txt
          
          echo "=== Git Status After Add ==="
          git status
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Changes detected, committing..."
            
            COMMIT_MSG="ğŸ“Š Update TVL: $CURRENT_TVL"
            if [ "$INCREASED" = "true" ]; then
              COMMIT_MSG="ğŸš€ TVL Increased: $CURRENT_TVL"
            fi
            
            if git commit -m "$COMMIT_MSG"; then
              echo "âœ… Successfully committed changes"
              
              # ãƒ—ãƒƒã‚·ãƒ¥ã‚’è©¦è¡Œ
              echo "Pushing to GitHub..."
              if git push; then
                echo "âœ… Successfully pushed to GitHub"
              else
                echo "âŒ Failed to push to GitHub"
                echo "Git remote info:"
                git remote -v
                echo "Git branch info:"
                git branch -v
                exit 1
              fi
            else
              echo "âŒ Failed to commit changes"
              exit 1
            fi
          fi
          
      - name: Summary
        run: |
          CURRENT_TVL="${{ steps.api_call.outputs.current_tvl }}"
          INCREASED="${{ steps.api_call.outputs.increased }}"
          LAST_TVL="${{ steps.get_tvl.outputs.last_tvl }}"
          
          echo "=== TVL Monitoring Summary ==="
          echo "Previous TVL: $LAST_TVL"
          echo "Current TVL: $CURRENT_TVL"
          echo "Increased: $INCREASED"
          
          if [ "$INCREASED" = "true" ]; then
            DIFFERENCE=$(echo "$CURRENT_TVL - $LAST_TVL" | bc -l)
            echo "ğŸš€ TVL increased by $DIFFERENCE! Discord notification sent."
          else
            echo "ğŸ“Š No TVL increase detected."
          fi
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹æœ€çµ‚ç¢ºèª
          if [ -f tvl_value.txt ]; then
            echo "âœ… tvl_value.txt exists with value: $(cat tvl_value.txt)"
          else
            echo "âŒ tvl_value.txt not found!"
          fi
          
      - name: Cleanup
        run: rm -f response.json
        if: always()